{% extends "front/base.html.twig" %}
{% block title %}{% trans %}SEARCH RESULT TITLE{% endtrans %}{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
          integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
          crossorigin=""/>
    <link href='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/leaflet.fullscreen.css' rel='stylesheet' />
{% endblock %}

{% block content_title %}{% trans %}SEARCH RESULT{% endtrans %} {{ city|capitalize }}{% endblock %}

{% block content %}
    <section class="listing">
        <script>
            var dataPopup = [];
        </script>
        <div id="listing-map"></div>
        {% for idx, immo in result %}
            <article class="pure-g realestate">
                <div class="pure-u-1-8">
                    <figure>
                        <a href="{{ path('app_buy_visit', {pk: immo.pk}) }}">
                            <div class="image-container">
                                <img class="pure-img endmargin" src="/upload/placeholder.jpg"/>
                                {% if immo.newentry %}
                                    <div class="flag"><img src="{{ asset('img/flag-nouveau.svg') }}"/></div>
                                    {% endif %}
                                    {% if immo.offer %}
                                    <div class="flag flag-right"><img src="{{ asset('img/flag-offre.svg') }}"/></div>
                                    {% endif %}
                            </div>
                        </a>
                    </figure>
                </div>
                <div class="pure-u-3-4">
                    <figcaption>
                        <a href="{{ path('app_buy_visit', {pk: immo.pk}) }}">
                            <h3>{{ immo|catchline }}</h3>
                        </a>
                        <a href="{{ path('app_buy_visit', {pk: immo.pk}) }}">
                            <p>{{ immo.description }}</p>
                        </a>
                        <nav class="pure-g navbar">
                            <div class="pure-u-1-3">
                                <a href="{{ path('app_buy_detail', {pk: immo.pk}) }}">
                                    <i class="icon-loupe"></i>
                                    {% trans %}VIEW DETAIL{% endtrans %}
                                </a>
                            </div>                           
                            <div class="pure-u-1-3">
                                <a href="{{ path('app_buy_visit', {pk: immo.pk}) }}">
                                    <i class="icon-vr360"></i>
                                    {% trans %}VIRTUAL VISIT{% endtrans %}
                                </a>
                            </div>
                            <div class="pure-u-1-3">
                                <a href="#" id="openpopup{{ immo.pk }}">
                                    <i class="icon-location"></i>
                                    {% trans %}WATCH ON MAP{% endtrans %}
                                </a>
                            </div>
                        </nav>
                        <ul class="tags">
                            {% for tag in immo.tag %}
                                <li style="color: hsl({{ crc_hue(tag) }}, 70%, 25%); background-color: hsl({{ crc_hue(tag) }}, 70%, 85%)">
                                    {{ tag }}
                                </li>
                            {% endfor %}
                        </ul>
                    </figcaption>
                </div>
                <div class="pure-u-1-8">
                    <nav class="actions">
                        <h3>{{ immo.price|format_currency(immo.currency, locale='fr', attrs={fraction_digit: 0}) }}</h3>
                        <a href="#" class="color-action"><i class="icon-arrowright big"></i><br/>
                            {% trans %}RDV SETTING{% endtrans %}</a>
                    </nav>
                </div>
            </article>
            <script>
                dataPopup.push({
                    title: '{{ immo|catchline|e('js') }}',
                    thumb: '<img class="pure-img endmargin" src="/upload/placeholder.jpg"/>',
                    navig: '{{ include("front/widget/realestate_navicon.html.twig")|spaceless }}',
                    coord: [{{ immo.latitude }}, {{ immo.longitude }}],
                    popup: 'openpopup{{ immo.pk }}'
                });
            </script>
        {% endfor %}
        <footer></footer>
    </section>
{% endblock %}
{% block javascripts %}
    {{ parent() }}
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
            integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
    crossorigin=""></script>    
    <script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/Leaflet.fullscreen.min.js'></script>
    <script>
                // initialising the leaflet map
                var map = L.map('listing-map', {fullscreenControl: true})
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map)

                // scanning the real estate data for marker and adding external control (openPopup)
                for (var idx = 0; idx < dataPopup.length; idx++) {
                    var immo = dataPopup[idx]
                    // getting the <a> for opening the popup
                    var obj = document.getElementById(immo.popup)
                    // adding the leaflet marker on the DOM tag
                    obj.marker = L.marker(immo.coord)
                            .addTo(map)
                            .bindPopup(immo.thumb + immo.navig + immo.title, {className: 'immo-popup-map'})
                    // adding the event observer on the <a> tag
                    obj.onclick = function (e) {
                        document.getElementById('listing-map').style.height = '500px'
                        map.invalidateSize()
                        e.target.marker.openPopup()
                    }
                }

                // reisize de leaflet map to fit the real estate markers
                map.fitBounds({{ result.boundaries|json_encode() }})
    </script>
{% endblock %}